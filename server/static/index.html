<html>
<head>
<title>Rebusrally-status</title>
    <script language="JavaScript">
        function on_send_message() {
            var message = document.getElementById("sendmessage").value;
            document.getElementById("sendmessage").value = "";
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/sendmessage", true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send(message);
        }

        function on_start_rally() {
            var answer = confirm("This starts the rally, are you sure?");
            if (answer) {
                var xhttp = new XMLHttpRequest();
                xhttp.open("POST", "/startrally", true);
                xhttp.setRequestHeader("Content-type", "text/plain");
                xhttp.send("START");
            }
        }

        function on_start_afternoon() {
            var answer = confirm("This starts the afternoon, are you sure?");
            if (answer) {
                var xhttp = new XMLHttpRequest();
                xhttp.open("POST", "/startafternoon", true);
                xhttp.setRequestHeader("Content-type", "text/plain");
                xhttp.send("START");
            }
        }

        function on_warp() {
            var team = document.getElementById("debug_team").value;
            var section = document.getElementById("warp_section").value;
            var frame = document.getElementById("warp_frame").value;
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/warp/" + team + "/" + section, true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send(frame);
        }

        function on_solve_morning_rebus() {
            var team = document.getElementById("debug_team").value;
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/debug_solved_start_rebus/" + team, true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send("Do it!");
        }

        function on_solve_afternoon_rebus() {
            var team = document.getElementById("debug_team").value;
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/debug_solved_lunch_rebus/" + team, true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send("Do it!");
        }

        function on_terminate_team() {
            var team = document.getElementById("debug_team").value;
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/terminate/" + team, true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send("Do it!");
        }

        function on_backup_team() {
            var team = document.getElementById("debug_team").value;
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/force_backup/" + team, true);
            xhttp.setRequestHeader("Content-type", "text/plain");
            xhttp.send("Do it!");
        }

        var team_status_interval = null;
        function body_loaded() {
            team_status_interval = setInterval(on_update_team_status_interval, 1000);
        }

        const team_update_http_request = new XMLHttpRequest();
        function on_team_update_receive_data(e) {
            if (team_update_http_request.readyState == 4 && team_update_http_request.status == 200) {
                build_teams_info(team_update_http_request.responseText)
                //console.log(team_update_http_request.responseText)
            } else {
                //TODO: error handling
                //console.log("other status: " + team_update_http_request.readyState + ", " +team_update_http_request.status);
            }
        }

        team_update_http_request.onreadystatechange = on_team_update_receive_data;
        const team_update_url = "/teams";
        function on_update_team_status_interval() {
            team_update_http_request.open("GET", team_update_url);
            team_update_http_request.send()
        }

        function build_teams_info(json_text) {
            console.log(json_text);
            var json_obj = JSON.parse(json_text);
            var s = "<table><tr>";

            col_count = 0;
            for (team_number in json_obj) {
                col_count++;
                if (col_count == 5) {
                    col_count = 0;
                    s += "</tr><tr>";
                }
                s += "<td>";
                s += build_team_info(json_obj[team_number]);
                s += "</td>\n";
            }
            s += "</tr></table>";
            document.getElementById("team_statuses").innerHTML = s;
        }

        function get_value(json_obj, property, def) {
            if (def === undefined) def = "";
            if (json_obj.hasOwnProperty(property)) {
                return json_obj[property];
            }
            return def;
        }

        function has_value(json_obj, property) {
            if (json_obj.hasOwnProperty(property)) {
                return true;
            }
            return false;
        }

        function get_json_date_value(json_obj, property) {
            if (has_value(json_obj, property)) {
                val = json_obj[property];
                if (val != null) {
                    return val;
                }
            }
            return "-";
        }

        const stage_mapping = {
            "0": "Not started",
            "1": "Morning started",
            "2": "At lunch",
            "3": "Afternoon started",
            "4": "Found goal",
            "5": "Rally ended"
        };
        function get_rally_stage(team_json) {
            if (has_value(team_json), "rally-stage") {
                stage_number = team_json["rally-stage"];
                return stage_mapping[stage_number];
            }
            return "N/A";
        }

        function build_team_info(team_json) {
            var s = "<h3>" + get_value(team_json, "team-number") + ": " + get_value(team_json, "team-name") + "</h3>\n";
            var position = "";
            if (has_value(team_json, "minibus")) {
                var minibus = team_json["minibus"];
                if (has_value(minibus, "current_section")) {
                    position += "<tr><td>Section " + minibus["current_section"] + "</td></tr>";
                }
                if (has_value(minibus, "distance")) {
                    position += "<tr><td>Distance " + minibus["distance"] + "</td></tr>";
                }
                if (has_value(minibus, "speed")) {
                    position += "<tr><td>Speed " + minibus["speed"] + "</td></tr>";
                }
                if (has_value(minibus, "seating")) {
                    var all_user_ids = new Set();
                    var all_users = {};
                    if (has_value(team_json, "connected-users")) {
                        var connected_users = team_json["connected-users"];
                        for (player_index in connected_users) {
                            player = connected_users[player_index];
                            var id = player["id"];
                            all_user_ids.add(id);
                            all_users[id.toString()] = player["name"];
                        }
                    }

                    var seating = minibus["seating"];
                    s += "<table border='1'>";
                    for (var i = 0; i < 9; i++) {
                        if (i % 3 == 0) {
                            s += "<tr>";
                        }

                        s += "<td>";
                        var seat_number = i + 1;
                        var anyone = get_value(seating, seat_number.toString(), null);
                        if (anyone != null) {
                            var user_id = get_value(anyone, "id");
                            s += "[" + user_id + "] ";
                            s += get_value(anyone, "name");
                            all_user_ids.delete(user_id);
                        }
                        s += "</td>";

                        if (i % 3 == 2) {
                            s += "</tr>";
                        }
                    }
                    if (all_user_ids.size > 0) {
                        s += "<tr><td colspan='3'>";
                        for (let user_id of all_user_ids) {
                            s += "[" + user_id + "] ";
                            s += all_users[user_id.toString()];
                            s += " ";
                        }
                        s += "</td></tr>\n";
                    }
                    s += "</table>";
                }
            }
            s += "Status: " + get_rally_stage(team_json) + "<br>\n";
            if (position.length > 0) {
                s += "<table><tr><td>Position</td><td><table>" + position + "</table></td></tr></table>\n";
            } else {
                s += "Position: Unknown<br>\n";
            }
            s += "<br>\n";
            s += "Start time: " + get_json_date_value(team_json, "start-time") + "<br>\n";
            s += "Lunch time: " + get_json_date_value(team_json, "lunch-time") + "<br>\n";
            s += "Arrived at goal: " + get_json_date_value(team_json, "found-goal-time") + "<br>\n";
            s += "Ended: " + get_json_date_value(team_json, "goal-time") + "<br>\n";

            return s;
        }
    </script>
</head>
<body onload="body_loaded()">
Send a message to all <input type="text" id="sendmessage" name="sendmessage" value=""/><input type="button" onclick="on_send_message()" value="Send"/><br>
<br>
<input type="button" onclick="on_start_rally()" value="Start the rally! (publish first rebus)"/><br>
<br>
<input type="button" onclick="on_start_afternoon()" value="Start the afternoon! (publish lunch rebus)"/><br>
<br>
<h1>Debug</h1>
Team <input type="text" id="debug_team" name="debug_team" value="1"/><br>
Warp team to section <input type="text" id="warp_section" name="warp_section" value="1"/> frame <input type="text" id="warp_frame" name="warp_frame" value=""/> <input type="button" onclick="on_warp()" value="Warp"/><br>
<input type="button" onclick="on_solve_morning_rebus()" value="Solve morning rebus"/><br>
<input type="button" onclick="on_solve_afternoon_rebus()" value="Solve afternoon rebus"/><br>
<input type="button" onclick="on_backup_team()" value="Force backup"/><br>
<input type="button" onclick="on_terminate_team()" value="Terminate team"/><br>
<!--
<input type="button" onclick="on_debug_restart()" value="Reset bus position"/><br>
-->
<div id="team_statuses">&nbsp;</div>
</body>
</html>